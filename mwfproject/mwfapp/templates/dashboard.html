{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="pb-10 max-w-7xl mx-auto flex">
    <!-- Sidebar is fixed in base -->

    <!-- Main Content -->
    <main class="flex-1 p-4 ml-[50px] bg-[var(--cream)]">

        <!-- Top Stats Cards -->
        <div class="flex flex-col lg:flex-row gap-4 mb-6">
            {% if user.role == "SALES_AGENT" or user.role == "MANAGER" %}
            <div class="flex-1 bg-[#fcf2df] border border-[#f3ceaf] rounded-xl p-6 animate-fade-in">
                <h2 class="text-4xl md:text-5xl text-[#643310]">Total Sale Items</h2>
                <p class="text-5xl font-bold text-[#643310]">{{ total_sales|default:"0" }}</p>

                <a href="{% url 'salesPage' %}"
                   class="inline-block mt-6 px-6 text-lg py-2 rounded-full text-white font-bold bg-[#643310]">
                    Review Sales
                </a>
            </div>
            {% endif %}
        </div>

        {% if user.role in "ADMIN MANAGER" %}
        <div class="grid grid-cols-1 md:grid-cols-2 mt-6 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl border border-[#f3ceaf] shadow-xl p-6 h-50 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl animate-slide-up" style="animation-delay: 0.1s">
                <h3 class="text-xl font-bold text-[#643310]">Daily Sales</h3>
                <p class="text-3xl mt-2">UGX <span id="daily-sales">{{ daily_total|default:"0"|intcomma }}</span></p>
                <p class="text-gray-600">Including 5% transport fees</p>
            </div>

            <div class="bg-white rounded-xl border border-[#f3ceaf] shadow-lg p-6 h-48 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl animate-slide-up" style="animation-delay: 0.2s">
                <h3 class="text-xl font-bold text-[#643310]">Monthly Sales</h3>
                <p class="text-3xl mt-2 text-gray-800">UGX {{ monthly_sales|default:"0"|intcomma }}</p>
                <p class="text-gray-600">Including Transport Fees</p>
            </div>

            <div class="bg-white rounded-xl border border-[#f3ceaf] shadow-lg p-6 h-48 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl animate-slide-up" style="animation-delay: 0.3s">
                <h3 class="text-xl font-bold text-[#643310]">Total Stock Items</h3>
                <p class="text-3xl mt-2 text-gray-800">{{ total_stock|default:"0" }}</p>
                <p class="text-gray-600">Across all categories</p>
            </div>
        </div>
        {% endif %}

        {% if user.role == "SALES_AGENT" %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl border border-[#f3ceaf] shadow-lg p-6 h-48 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl animate-slide-up" style="animation-delay: 0.3s">
                <h3 class="text-xl font-bold text-[#643310]">Total Stock Items</h3>
                <p class="text-3xl mt-2 text-gray-800">{{ total_stock|default:"0" }}</p>
                <p class="text-gray-600">Across all categories</p>
            </div>
            <div class="bg-white rounded-xl border border-[#f3ceaf] shadow-xl p-6 h-50 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl animate-slide-up" style="animation-delay: 0.1s">
                <h3 class="text-xl font-bold text-[#643310]">Daily Sales</h3>
                <p class="text-3xl mt-2">UGX <span id="daily-sales">{{ daily_total|default:"0"|intcomma }}</span></p>
                <p class="text-gray-600">Including 5% transport fees</p>
            </div>
        </div>
        {% endif %}

        <!-- Charts Section -->
        {% if user.role == "MANAGER" %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Line Chart -->
            <div class="bg-white p-6 rounded-xl mt-6 shadow-md">
                <h2 class="text-xl font-bold mb-4">Monthly Sales</h2>
                <canvas id="salesLineChart" class="mt-20"></canvas>
            </div>

            <!-- Pie Chart -->
            <div class="bg-white p-6 rounded-xl mt-6 shadow-md">
                <h2 class="text-xl font-bold mb-4">Stocks Distribution by Category</h2>
                <canvas id="salesPieChart"></canvas>
            </div>
        </div>
        {% endif %}

    </main>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const lineCanvas = document.getElementById('salesLineChart');
if (lineCanvas) {
    const ctxLine = lineCanvas.getContext('2d');
    new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'Sales (UGX)',
                data: {{ monthly_sales_data|safe }},
                backgroundColor: 'rgba(100,51,16,0.2)',
                borderColor: 'rgba(100,51,16,1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

const pieCanvas = document.getElementById('salesPieChart');
if (pieCanvas) {
    const ctxPie = pieCanvas.getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                label: 'Stocks Distribution',
                data: {{ category_sales_data|safe }},
                backgroundColor: [
                    '#132a13',
                    '#31572c',
                    '#4f772d',
                    '#90a955',
                    '#ecf39e',
                    '#fefee3',
                   
                ],
                borderColor: [
                    '#7aa0bdff',
                    '#649d9bff',
                    '#75ad82ff',
                    '#a4cfaeff',
                    '#b1d0b8ff',
                    '#b1d0b8ff'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}
</script>
{% endblock %}
